<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de D√≠vidas - O que me Devem</title>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100%;
      width: 100%;
    }

    * {
      box-sizing: border-box;
    }

    .app-container {
      width: 100%;
      min-height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2rem 1rem;
    }

    .content-wrapper {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .header h1 {
      color: #ffffff;
      font-size: 2.5rem;
      margin: 0 0 0.5rem 0;
      font-weight: 700;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .form-section h2 {
      color: #2d3748;
      font-size: 1.5rem;
      margin: 0 0 1.5rem 0;
      font-weight: 600;
    }

    .form-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: 1fr 1fr;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      color: #4a5568;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .btn {
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      width: 100%;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-success {
      background: #48bb78;
      color: #ffffff;
    }

    .btn-success:hover:not(:disabled) {
      background: #38a169;
    }

    .btn-warning {
      background: #ed8936;
      color: #ffffff;
    }

    .btn-warning:hover:not(:disabled) {
      background: #dd6b20;
    }

    .btn-danger {
      background: #f56565;
      color: #ffffff;
    }

    .btn-danger:hover:not(:disabled) {
      background: #e53e3e;
    }

    .btn-edit {
      background: #4299e1;
      color: #ffffff;
    }

    .btn-edit:hover:not(:disabled) {
      background: #3182ce;
    }

    .btn-info {
      background: #4299e1;
      color: #ffffff;
    }

    .btn-info:hover:not(:disabled) {
      background: #3182ce;
    }

    .total-section {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: #ffffff;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .total-section h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 500;
      opacity: 0.9;
    }

    .total-section .amount {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0;
    }

    .list-section h2 {
      color: #2d3748;
      font-size: 1.5rem;
      margin: 0 0 1.5rem 0;
      font-weight: 600;
    }

    .dividas-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .divida-item {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.25rem;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 1.5rem;
      align-items: center;
      transition: all 0.2s;
      min-height: 80px;
    }

    .divida-item:hover {
      border-color: #cbd5e0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .divida-item.pago {
      background: #f0fff4;
      border-color: #9ae6b4;
    }

    .divida-item.atrasada {
      background: #fff5f5;
      border-color: #fc8181;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(245, 101, 101, 0); }
    }

    .divida-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .divida-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .divida-nome {
      font-size: 1.125rem;
      font-weight: 600;
      color: #2d3748;
      margin: 0;
    }

    .divida-valor {
      font-size: 1.75rem;
      font-weight: 700;
      color: #667eea;
      margin: 0;
      text-align: center;
    }

    .divida-item.pago .divida-valor {
      color: #48bb78;
      text-decoration: line-through;
    }

    .divida-item.atrasada .divida-valor {
      color: #f56565;
    }

    .divida-status {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      white-space: nowrap;
      text-align: center;
      min-width: 100px;
    }

    .status-pendente {
      background: #fed7d7;
      color: #c53030;
    }

    .status-pago {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-atrasada {
      background: #fed7d7;
      color: #c53030;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .divida-detalhes {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      color: #718096;
      font-size: 0.75rem;
    }

    .divida-detalhes span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .divida-observacoes {
      color: #718096;
      font-size: 0.75rem;
      font-style: italic;
      margin: 0;
    }

    .divida-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #718096;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      color: #4a5568;
      margin: 0 0 0.5rem 0;
    }

    .empty-state p {
      margin: 0;
      font-size: 0.875rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #2d3748;
      color: #ffffff;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
    }

    .toast.warning {
      background: #ed8936;
    }

    .toast.danger {
      background: #f56565;
    }

    .toast.success {
      background: #48bb78;
    }

    .toast.info {
      background: #4299e1;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      margin: 0;
      color: #2d3748;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #718096;
    }

    .modal-body {
      margin-bottom: 1.5rem;
    }

    .modal-footer {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .notificacao-badge {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: #f56565;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      cursor: pointer;
      z-index: 999;
      animation: pulse 2s infinite;
    }

    .prazo-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 6px;
      background: #f7fafc;
    }

    .prazo-proximo {
      background: #feebc8;
      color: #c05621;
    }

    .prazo-atrasado {
      background: #fed7d7;
      color: #c53030;
    }

    .prazo-normal {
      background: #f0fff4;
      color: #22543d;
    }

    .categoria-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-right: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .categoria-emprestimo { background: #bee3f8; color: #2c5282; }
    .categoria-servico { background: #fed7d7; color: #c53030; }
    .categoria-venda { background: #c6f6d5; color: #22543d; }
    .categoria-outro { background: #e9d8fd; color: #553c9a; }

    .estatisticas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .estatistica-card {
      background: #f7fafc;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .estatistica-valor {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
      margin: 0.5rem 0;
    }

    .estatistica-label {
      font-size: 0.875rem;
      color: #718096;
      margin: 0;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .divida-item {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .divida-valor {
        text-align: left;
      }

      .divida-actions {
        flex-direction: column;
        width: 100%;
      }

      .divida-actions button {
        width: 100%;
      }

      .modal-content {
        width: 95%;
        padding: 1rem;
      }

      .estatisticas-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div class="app-container">
   <div class="content-wrapper">
    <header class="header">
     <h1 id="titulo-principal">üí∞ D√≠vidas a Receber</h1>
     <p style="color: rgba(255,255,255,0.8); margin: 0;">Controle do que as pessoas te devem</p>
    </header>
    
    <!-- Bot√£o de notifica√ß√µes -->
    <div id="notificacao-badge" class="notificacao-badge" style="display: none;" onclick="mostrarNotificacoes()">0</div>
    
    <!-- Estat√≠sticas -->
    <div class="card">
      <h2>üìä Resumo Financeiro</h2>
      <div class="estatisticas-grid" id="estatisticas-container">
        <!-- Ser√° preenchido pelo JavaScript -->
      </div>
    </div>
    
    <div class="card form-section">
     <h2>‚ûï Adicionar Nova D√≠vida</h2>
     <form id="form-devedor">
      <div class="form-grid">
       <div class="form-group"><label for="input-nome">Nome do Devedor</label> <input type="text" id="input-nome" required placeholder="Ex: Maria Santos">
       </div>
       <div class="form-group"><label for="input-valor">Valor que me Deve (MT)</label> <input type="number" id="input-valor" step="0.01" min="0" required placeholder="0,00">
       </div>
       <div class="form-group"><label for="input-categoria">Categoria da D√≠vida</label> 
         <select id="input-categoria">
           <option value="emprestimo">üí∞ Empr√©stimo de dinheiro</option>
           <option value="servico">üîß Servi√ßo prestado</option>
           <option value="venda">üõí Venda de produto</option>
           <option value="outro">üìù Outro</option>
         </select>
       </div>
       <div class="form-group"><label for="input-data">Data da D√≠vida</label> <input type="date" id="input-data">
       </div>
       <div class="form-group"><label for="input-prazo">Prazo para Pagar (dias)</label> <input type="number" id="input-prazo" min="1" placeholder="Ex: 15 (opcional)">
       </div>
       <div class="form-group full-width"><label for="input-observacoes">Detalhes/Motivo</label> <textarea id="input-observacoes" placeholder="Ex: Pagamento pelo conserto do carro, Venda do celular..."></textarea>
       </div>
      </div><button type="submit" class="btn btn-primary" id="btn-submit"> <span id="btn-text-adicionar">‚ûï Registrar D√≠vida</span> </button>
     </form>
    </div>
    <div class="total-section">
     <h3 id="label-total">üí∞ Total a Receber (Pendente)</h3>
     <p class="amount" id="total-pendente">MT 0,00</p>
    </div>
    <div class="card list-section">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
       <h2>üìã Lista de Devedores</h2>
       <button class="btn btn-small btn-info" onclick="mostrarNotificacoes()">üîî Ver Cobran√ßas ({notificacaoCount})</button>
     </div>
     <div id="filtros" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
       <button class="btn btn-small" onclick="filtrarDividas('todos')">Todos</button>
       <button class="btn btn-small" onclick="filtrarDividas('pendente')">Pendentes</button>
       <button class="btn btn-small" onclick="filtrarDividas('pago')">Pagas</button>
       <button class="btn btn-small" onclick="filtrarDividas('atrasada')">Atrasadas</button>
       <select class="btn btn-small" onchange="filtrarPorCategoria(this.value)" style="padding: 0.5rem;">
         <option value="">Todas Categorias</option>
         <option value="emprestimo">Empr√©stimo</option>
         <option value="servico">Servi√ßo</option>
         <option value="venda">Venda</option>
         <option value="outro">Outro</option>
       </select>
     </div>
     <div id="dividas-container" class="dividas-list"></div>
    </div>
   </div>
  </div>

  <!-- Modal de Notifica√ß√µes -->
  <div id="modal-notificacoes" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîî Cobran√ßas Pendentes</h2>
        <button class="close-modal" onclick="fecharModal()">√ó</button>
      </div>
      <div class="modal-body" id="modal-notificacoes-body">
        <!-- Conte√∫do das notifica√ß√µes ser√° inserido aqui -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="fecharModal()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'dividas_a_receber';
    let currentRecordCount = 0;
    let dividas = [];
    let editingId = null;
    let lembreteInterval;
    let filtroAtual = 'todos';
    let categoriaFiltro = '';

    // Solicitar permiss√£o para notifica√ß√µes
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // Fun√ß√µes para gerenciar localStorage
    function carregarDividas() {
      const dados = localStorage.getItem(STORAGE_KEY);
      if (dados) {
        dividas = JSON.parse(dados);
        currentRecordCount = dividas.length;
      } else {
        dividas = [];
        currentRecordCount = 0;
      }
      renderDividas();
      calcularTotal();
      atualizarEstatisticas();
      verificarPrazos();
      iniciarVerificacaoPrazos();
    }

    function salvarDividas() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(dividas));
      currentRecordCount = dividas.length;
      renderDividas();
      calcularTotal();
      atualizarEstatisticas();
      verificarPrazos();
    }

    function atualizarEstatisticas() {
      const container = document.getElementById('estatisticas-container');
      
      const totalPendente = dividas
        .filter(d => d.status === 'pendente')
        .reduce((sum, d) => sum + d.valor, 0);
      
      const totalRecebido = dividas
        .filter(d => d.status === 'pago')
        .reduce((sum, d) => sum + d.valor, 0);
      
      const totalGeral = dividas.reduce((sum, d) => sum + d.valor, 0);
      
      const devedoresPendentes = dividas.filter(d => d.status === 'pendente').length;
      const devedoresAtrasados = dividas.filter(d => d.atrasada).length;
      
      container.innerHTML = `
        <div class="estatistica-card">
          <p class="estatistica-label">üí∞ A Receber</p>
          <p class="estatistica-valor">MT ${totalPendente.toFixed(2).replace('.', ',')}</p>
        </div>
        <div class="estatistica-card">
          <p class="estatistica-label">‚úÖ Recebido</p>
          <p class="estatistica-valor">MT ${totalRecebido.toFixed(2).replace('.', ',')}</p>
        </div>
        <div class="estatistica-card">
          <p class="estatistica-label">üë§ Devedores</p>
          <p class="estatistica-valor">${devedoresPendentes}</p>
          ${devedoresAtrasados > 0 ? `<p style="color: #f56565; font-size: 0.75rem; margin: 0;">(${devedoresAtrasados} atrasados)</p>` : ''}
        </div>
        <div class="estatistica-card">
          <p class="estatistica-label">üìä Total Geral</p>
          <p class="estatistica-valor">MT ${totalGeral.toFixed(2).replace('.', ',')}</p>
        </div>
      `;
    }

    function iniciarVerificacaoPrazos() {
      // Verificar prazos a cada 1 minuto
      if (lembreteInterval) {
        clearInterval(lembreteInterval);
      }
      lembreteInterval = setInterval(verificarPrazos, 60000); // 1 minuto
    }

    function verificarPrazos() {
      const agora = new Date();
      let notificacoesCount = 0;
      const notificacoes = [];

      dividas.forEach(divida => {
        if (divida.status !== 'pago' && divida.data && divida.prazo) {
          const dataDivida = new Date(divida.data);
          const dataVencimento = new Date(dataDivida);
          dataVencimento.setDate(dataVencimento.getDate() + parseInt(divida.prazo));
          
          const diasAtraso = Math.floor((agora - dataVencimento) / (1000 * 60 * 60 * 24));
          
          // Se est√° atrasada
          if (diasAtraso > 0) {
            divida.atrasada = true;
            divida.diasAtraso = diasAtraso;
            notificacoesCount++;
            
            // Criar notifica√ß√£o para d√≠vida atrasada
            notificacoes.push({
              tipo: 'atrasada',
              titulo: `‚è∞ D√≠vida Atrasada: ${divida.nome}`,
              mensagem: `${divida.nome} te deve MT ${divida.valor.toFixed(2)} e est√° atrasada h√° ${diasAtraso} dia(s).`,
              dividaId: divida.id
            });
          }
          // Se vence em at√© 3 dias
          else if (diasAtraso >= -3 && diasAtraso < 0) {
            divida.proximoVencimento = true;
            divida.diasRestantes = Math.abs(diasAtraso);
            notificacoesCount++;
            
            // Criar notifica√ß√£o para vencimento pr√≥ximo
            notificacoes.push({
              tipo: 'proximo',
              titulo: `‚ö†Ô∏è Vencimento Pr√≥ximo: ${divida.nome}`,
              mensagem: `${divida.nome} deve te pagar MT ${divida.valor.toFixed(2)} em ${Math.abs(diasAtraso)} dia(s).`,
              dividaId: divida.id
            });
          }
        }
      });

      // Atualizar badge de notifica√ß√µes
      const badge = document.getElementById('notificacao-badge');
      if (notificacoesCount > 0) {
        badge.textContent = notificacoesCount;
        badge.style.display = 'flex';
        
        // Atualizar contador no bot√£o
        const botoesNotificacao = document.querySelectorAll('[onclick*="mostrarNotificacoes"]');
        botoesNotificacao.forEach(botao => {
          if (botao.textContent.includes('(')) {
            botao.textContent = botao.textContent.replace(/\(\d+\)/, `(${notificacoesCount})`);
          } else {
            botao.textContent += ` (${notificacoesCount})`;
          }
        });
      } else {
        badge.style.display = 'none';
        // Remover contador dos bot√µes
        const botoesNotificacao = document.querySelectorAll('[onclick*="mostrarNotificacoes"]');
        botoesNotificacao.forEach(botao => {
          botao.textContent = botao.textContent.replace(/ \(\d+\)/, '');
        });
      }

      // Mostrar notifica√ß√£o do navegador se houver notifica√ß√µes atrasadas
      if (notificacoes.length > 0 && 'Notification' in window && Notification.permission === 'granted') {
        notificacoes.forEach(notif => {
          if (notif.tipo === 'atrasada') {
            new Notification(notif.titulo, {
              body: notif.mensagem,
              icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>'
            });
          }
        });
      }

      return notificacoes;
    }

    async function init() {
      carregarDividas();
      
      const form = document.getElementById('form-devedor');
      form.addEventListener('submit', handleSubmit);
    }

    function getNomeCategoria(codigo) {
      const categorias = {
        'emprestimo': 'üí∞ Empr√©stimo',
        'servico': 'üîß Servi√ßo',
        'venda': 'üõí Venda',
        'outro': 'üìù Outro'
      };
      return categorias[codigo] || codigo;
    }

    async function handleSubmit(e) {
      e.preventDefault();

      const nome = document.getElementById('input-nome').value.trim();
      const valor = parseFloat(document.getElementById('input-valor').value);
      const categoria = document.getElementById('input-categoria').value;
      const data = document.getElementById('input-data').value;
      const prazo = document.getElementById('input-prazo').value;
      const observacoes = document.getElementById('input-observacoes').value;

      // Valida√ß√£o b√°sica
      if (!nome || isNaN(valor) || valor <= 0) {
        showToast("Por favor, preencha o nome e um valor v√°lido!", 'warning');
        return;
      }

      const btnSubmit = document.getElementById('btn-submit');
      const btnText = document.getElementById('btn-text-adicionar');
      const originalText = btnText.textContent;

      btnSubmit.disabled = true;
      btnText.innerHTML = '<span class="loading-spinner"></span>';

      // Pequeno delay para mostrar o spinner
      await new Promise(resolve => setTimeout(resolve, 300));

      try {
        // Verificar se j√° existe uma d√≠vida com o mesmo nome (case-insensitive)
        const devedorExistente = dividas.find(d => 
          d.nome.toLowerCase() === nome.toLowerCase() && d.id !== editingId
        );

        if (devedorExistente) {
          // Atualizar d√≠vida existente somando o valor
          devedorExistente.valor += valor;
          devedorExistente.categoria = categoria || devedorExistente.categoria;
          devedorExistente.data = data || devedorExistente.data;
          devedorExistente.prazo = prazo || devedorExistente.prazo;
          devedorExistente.observacoes = observacoes || devedorExistente.observacoes;
          devedorExistente.status = "pendente"; // Reativar se estava pago
          delete devedorExistente.atrasada;
          delete devedorExistente.proximoVencimento;

          salvarDividas();
          showToast(`${nome} j√° te devia! Valor atualizado para MT ${devedorExistente.valor.toFixed(2)}`, 'success');
          document.getElementById('form-devedor').reset();
          if (editingId) cancelEdit();
        } else if (editingId) {
          // Editando uma d√≠vida existente
          const divida = dividas.find(d => d.id === editingId);
          if (divida) {
            divida.nome = nome;
            divida.valor = valor;
            divida.categoria = categoria;
            divida.data = data;
            divida.prazo = prazo;
            divida.observacoes = observacoes;
            delete divida.atrasada;
            delete divida.proximoVencimento;

            salvarDividas();
            showToast("D√≠vida atualizada com sucesso!", 'success');
            cancelEdit();
          }
        } else {
          // Criar nova d√≠vida
          if (currentRecordCount >= 999) {
            showToast("Limite de 999 devedores atingido. Por favor, remova alguns registros primeiro.", 'warning');
            btnSubmit.disabled = false;
            btnText.textContent = originalText;
            return;
          }

          const novaDivida = {
            id: Date.now().toString(),
            nome,
            valor,
            categoria,
            status: "pendente",
            data,
            prazo: prazo || null,
            observacoes,
            criadoEm: new Date().toISOString()
          };

          dividas.push(novaDivida);
          salvarDividas();
          showToast(`${nome} registrado como devedor!`, 'success');
          document.getElementById('form-devedor').reset();
        }
      } catch (error) {
        console.error("Erro:", error);
        showToast("Erro ao processar a opera√ß√£o. Tente novamente.", 'danger');
      } finally {
        btnSubmit.disabled = false;
        btnText.textContent = originalText;
      }
    }

    function renderDividas() {
      const container = document.getElementById('dividas-container');
      
      // Filtrar d√≠vidas
      let dividasFiltradas = [...dividas];
      
      if (filtroAtual === 'pendente') {
        dividasFiltradas = dividasFiltradas.filter(d => d.status === 'pendente');
      } else if (filtroAtual === 'pago') {
        dividasFiltradas = dividasFiltradas.filter(d => d.status === 'pago');
      } else if (filtroAtual === 'atrasada') {
        dividasFiltradas = dividasFiltradas.filter(d => d.atrasada);
      }
      
      if (categoriaFiltro) {
        dividasFiltradas = dividasFiltradas.filter(d => d.categoria === categoriaFiltro);
      }
      
      if (dividasFiltradas.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí∞</div>
            <h3>${filtroAtual !== 'todos' || categoriaFiltro ? 'Nenhuma d√≠vida encontrada' : 'Nenhuma d√≠vida registrada'}</h3>
            <p>${filtroAtual !== 'todos' || categoriaFiltro ? 'Tente mudar o filtro' : 'Adicione uma d√≠vida usando o formul√°rio acima'}</p>
          </div>
        `;
        return;
      }

      // Ordenar d√≠vidas
      dividasFiltradas.sort((a, b) => {
        if (a.atrasada && !b.atrasada) return -1;
        if (!a.atrasada && b.atrasada) return 1;
        if (a.proximoVencimento && !b.proximoVencimento) return -1;
        if (!a.proximoVencimento && b.proximoVencimento) return 1;
        if (a.status !== b.status) {
          return a.status === 'pendente' ? -1 : 1;
        }
        return new Date(b.criadoEm) - new Date(a.criadoEm);
      });

      container.innerHTML = dividasFiltradas.map(divida => {
        const statusClass = divida.status === 'pago' ? 'pago' : '';
        const atrasadaClass = divida.atrasada ? 'atrasada' : '';
        const statusLabel = divida.status === 'pago' ? 'Pago' : 'Pendente';
        let statusBadge = divida.status === 'pago' ? 'status-pago' : 'status-pendente';
        
        if (divida.atrasada) {
          statusLabel = 'Atrasada';
          statusBadge = 'status-atrasada';
        }
        
        const dataFormatada = divida.data ? new Date(divida.data + 'T00:00:00').toLocaleDateString('pt-BR') : '';
        
        // Calcular informa√ß√µes do prazo
        let prazoInfo = '';
        if (divida.data && divida.prazo && divida.status !== 'pago') {
          const dataDivida = new Date(divida.data);
          const dataVencimento = new Date(dataDivida);
          dataVencimento.setDate(dataVencimento.getDate() + parseInt(divida.prazo));
          
          const agora = new Date();
          const diasAtraso = Math.floor((agora - dataVencimento) / (1000 * 60 * 60 * 24));
          
          let prazoClass = 'prazo-normal';
          let prazoTexto = '';
          
          if (diasAtraso > 0) {
            prazoClass = 'prazo-atrasado';
            prazoTexto = `‚è∞ Atrasada h√° ${diasAtraso} dia(s)`;
          } else if (diasAtraso >= -3 && diasAtraso < 0) {
            prazoClass = 'prazo-proximo';
            prazoTexto = `‚ö†Ô∏è Vence em ${Math.abs(diasAtraso)} dia(s)`;
          } else {
            const diasRestantes = Math.abs(diasAtraso);
            prazoTexto = `‚úì Vence em ${diasRestantes} dia(s)`;
          }
          
          const vencimentoFormatado = dataVencimento.toLocaleDateString('pt-BR');
          prazoInfo = `<div class="prazo-info ${prazoClass}">
            <span>üìÖ Vencimento: ${vencimentoFormatado}</span>
            <span>${prazoTexto}</span>
          </div>`;
        }

        return `
          <div class="divida-item ${statusClass} ${atrasadaClass}" data-id="${divida.id}">
            <div class="divida-info">
              <h3 class="divida-nome">${divida.nome}</h3>
              <div class="divida-detalhes">
                <span class="categoria-badge categoria-${divida.categoria}">${getNomeCategoria(divida.categoria)}</span>
                ${dataFormatada ? `<span>üìÖ Data: ${dataFormatada}</span>` : ''}
                ${divida.prazo ? `<span>‚è±Ô∏è Prazo: ${divida.prazo} dias</span>` : ''}
                ${prazoInfo}
                ${divida.observacoes ? `<span class="divida-observacoes">üí¨ ${divida.observacoes}</span>` : ''}
              </div>
            </div>
            <p class="divida-valor">MT ${divida.valor.toFixed(2).replace('.', ',')}</p>
            <span class="divida-status ${statusBadge}">${statusLabel}</span>
            <div class="divida-actions">
              ${divida.status === 'pendente' ? 
                `<button class="btn btn-small btn-success" onclick="marcarComoPago('${divida.id}')">‚úÖ Recebido</button>` :
                `<button class="btn btn-small btn-warning" onclick="marcarComoPendente('${divida.id}')">‚Üª Repor</button>`
              }
              <button class="btn btn-small btn-edit" onclick="editarDivida('${divida.id}')">‚úé Editar</button>
              <button class="btn btn-small btn-info" onclick="enviarCobranca('${divida.id}')">üìß Cobrar</button>
              <button class="btn btn-small btn-danger" onclick="removerDivida('${divida.id}')">‚úï Remover</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function calcularTotal() {
      const totalPendente = dividas
        .filter(d => d.status === 'pendente')
        .reduce((sum, d) => sum + d.valor, 0);
      
      document.getElementById('total-pendente').textContent = 
        "MT " + totalPendente.toFixed(2).replace('.', ',');
    }

    async function marcarComoPago(id) {
      const divida = dividas.find(d => d.id === id);
      if (divida) {
        divida.status = 'pago';
        delete divida.atrasada;
        delete divida.proximoVencimento;
        
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span>';
        
        await new Promise(resolve => setTimeout(resolve, 300));
        
        salvarDividas();
        showToast(`‚úÖ Valor de MT ${divida.valor.toFixed(2)} recebido de ${divida.nome}!`, 'success');
        
        btn.disabled = false;
      }
    }

    async function marcarComoPendente(id) {
      const divida = dividas.find(d => d.id === id);
      if (divida) {
        divida.status = 'pendente';
        
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span>';
        
        await new Promise(resolve => setTimeout(resolve, 300));
        
        salvarDividas();
        showToast(`D√≠vida de ${divida.nome} restaurada como pendente.`, 'warning');
        
        btn.disabled = false;
      }
    }

    function editarDivida(id) {
      const divida = dividas.find(d => d.id === id);
      if (divida) {
        editingId = id;
        document.getElementById('input-nome').value = divida.nome;
        document.getElementById('input-valor').value = divida.valor;
        document.getElementById('input-categoria').value = divida.categoria;
        document.getElementById('input-data').value = divida.data || '';
        document.getElementById('input-prazo').value = divida.prazo || '';
        document.getElementById('input-observacoes').value = divida.observacoes || '';
        
        const btnText = document.getElementById('btn-text-adicionar');
        btnText.textContent = 'Atualizar D√≠vida';
        
        document.getElementById('form-devedor').scrollIntoView({ behavior: 'smooth' });
        showToast("Editando d√≠vida. Altere os campos e clique em Atualizar.", 'info');
      }
    }

    function cancelEdit() {
      editingId = null;
      document.getElementById('form-devedor').reset();
      const btnText = document.getElementById('btn-text-adicionar');
      btnText.textContent = '‚ûï Registrar D√≠vida';
    }

    async function removerDivida(id) {
      const divida = dividas.find(d => d.id === id);
      if (!divida) return;
      
      if (!confirm(`Tem certeza que deseja remover a d√≠vida de ${divida.nome}?`)) {
        return;
      }
      
      const item = document.querySelector('[data-id="' + id + '"]');
      const btns = item?.querySelectorAll('button');
      btns?.forEach(btn => btn.disabled = true);
      
      await new Promise(resolve => setTimeout(resolve, 300));
      
      dividas = dividas.filter(d => d.id !== id);
      salvarDividas();
      showToast(`D√≠vida de ${divida.nome} removida!`, 'success');
      
      if (editingId === id) {
        cancelEdit();
      }
    }

    function enviarCobranca(id) {
      const divida = dividas.find(d => d.id === id);
      if (divida) {
        // Criar mensagem de cobran√ßa
        let mensagem = `Ol√° ${divida.nome}, tudo bem?\n\n`;
        mensagem += `Lembrando sobre o valor que voc√™ me deve:\n\n`;
        mensagem += `üíµ Valor: MT ${divida.valor.toFixed(2)}\n`;
        
        if (divida.categoria) {
          mensagem += `üìã Motivo: ${getNomeCategoria(divida.categoria)}\n`;
        }
        
        if (divida.data && divida.prazo) {
          const dataDivida = new Date(divida.data);
          const dataVencimento = new Date(dataDivida);
          dataVencimento.setDate(dataVencimento.getDate() + parseInt(divida.prazo));
          const vencimentoFormatado = dataVencimento.toLocaleDateString('pt-BR');
          
          const agora = new Date();
          const diasAtraso = Math.floor((agora - dataVencimento) / (1000 * 60 * 60 * 24));
          
          mensagem += `üìÖ Vencimento: ${vencimentoFormatado}\n`;
          
          if (diasAtraso > 0) {
            mensagem += `‚è∞ Status: Atrasada h√° ${diasAtraso} dia(s)\n`;
          } else if (diasAtraso >= -3 && diasAtraso < 0) {
            mensagem += `‚ö†Ô∏è Status: Vence em ${Math.abs(diasAtraso)} dia(s)\n`;
          }
        }
        
        if (divida.observacoes) {
          mensagem += `üìù Detalhes: ${divida.observacoes}\n`;
        }
        
        mensagem += `\nPor favor, entre em contato para acertarmos.\n`;
        mensagem += `Agrade√ßo!`;
        
        // Mostrar modal com op√ß√µes para enviar
        const modalBody = document.getElementById('modal-notificacoes-body');
        modalBody.innerHTML = `
          <h3>üìß Cobrar ${divida.nome}</h3>
          <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
            <p><strong>Mensagem de cobran√ßa:</strong></p>
            <textarea id="mensagem-cobranca" style="width: 100%; height: 200px; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; margin: 0.5rem 0;">${mensagem}</textarea>
            <p style="font-size: 0.875rem; color: #718096; margin: 0.5rem 0;">Personalize a mensagem antes de enviar</p>
          </div>
          <p><strong>Enviar por:</strong></p>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
            <button class="btn btn-small btn-info" onclick="copiarMensagemCobranca()">üìã Copiar Mensagem</button>
            <button class="btn btn-small btn-success" onclick="enviarPorWhatsAppCobranca()">üì± WhatsApp</button>
            <button class="btn btn-small btn-primary" onclick="enviarPorEmailCobranca()">‚úâÔ∏è Email</button>
            <button class="btn btn-small btn-warning" onclick="enviarPorSMSCobranca()">üìû SMS</button>
          </div>
          <div id="mensagem-copiada-cobranca" style="display: none; color: #48bb78; margin-top: 0.5rem;">
            ‚úì Mensagem copiada para a √°rea de transfer√™ncia!
          </div>
        `;
        
        abrirModal('modal-notificacoes');
        
        // Armazenar a mensagem atual globalmente para usar nas fun√ß√µes
        window.mensagemCobrancaAtual = mensagem;
        window.dividaCobrancaAtual = divida;
      }
    }

    function copiarMensagemCobranca() {
      const textarea = document.getElementById('mensagem-cobranca');
      textarea.select();
      textarea.setSelectionRange(0, 99999);
      
      try {
        navigator.clipboard.writeText(textarea.value);
        document.getElementById('mensagem-copiada-cobranca').style.display = 'block';
        setTimeout(() => {
          document.getElementById('mensagem-copiada-cobranca').style.display = 'none';
        }, 3000);
      } catch (err) {
        document.execCommand('copy');
        document.getElementById('mensagem-copiada-cobranca').style.display = 'block';
        setTimeout(() => {
          document.getElementById('mensagem-copiada-cobranca').style.display = 'none';
        }, 3000);
      }
    }

    function enviarPorWhatsAppCobranca() {
      const mensagem = encodeURIComponent(window.mensagemCobrancaAtual);
      window.open(`https://wa.me/?text=${mensagem}`, '_blank');
      showToast("Abrindo WhatsApp com a mensagem de cobran√ßa!", 'success');
      fecharModal();
    }

    function enviarPorEmailCobranca() {
      const divida = window.dividaCobrancaAtual;
      const assunto = encodeURIComponent(`Lembrete de Pagamento - ${divida.nome}`);
      const corpo = encodeURIComponent(window.mensagemCobrancaAtual);
      window.open(`mailto:?subject=${assunto}&body=${corpo}`, '_blank');
      showToast("Abrindo cliente de email!", 'success');
      fecharModal();
    }

    function enviarPorSMSCobranca() {
      const mensagem = encodeURIComponent(window.mensagemCobrancaAtual);
      window.open(`sms:?body=${mensagem}`, '_blank');
      showToast("Abrindo aplicativo de mensagens!", 'success');
      fecharModal();
    }

    function mostrarNotificacoes() {
      const notificacoes = verificarPrazos();
      const modalBody = document.getElementById('modal-notificacoes-body');
      
      if (notificacoes.length === 0) {
        modalBody.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
            <h3 style="color: #48bb78;">Tudo em dia!</h3>
            <p>Nenhuma cobran√ßa pendente no momento.</p>
          </div>
        `;
      } else {
        let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
        html += '<p>üìã D√≠vidas que precisam de sua aten√ß√£o:</p>';
        
        notificacoes.forEach(notif => {
          const bgColor = notif.tipo === 'atrasada' ? '#fed7d7' : '#feebc8';
          const borderColor = notif.tipo === 'atrasada' ? '#fc8181' : '#ed8936';
          
          html += `
            <div style="border: 2px solid ${borderColor}; background: ${bgColor}; padding: 1rem; border-radius: 8px;">
              <h4 style="margin: 0 0 0.5rem 0;">${notif.titulo}</h4>
              <p style="margin: 0 0 0.5rem 0;">${notif.mensagem}</p>
              <button class="btn btn-small btn-info" onclick="enviarCobranca('${notif.dividaId}')" style="margin-top: 0.5rem;">
                üìß Enviar Cobran√ßa
              </button>
            </div>
          `;
        });
        
        html += '</div>';
        modalBody.innerHTML = html;
      }
      
      abrirModal('modal-notificacoes');
      
      // Resetar badge
      document.getElementById('notificacao-badge').style.display = 'none';
      verificarPrazos(); // Recalcular para atualizar contador
    }

    function filtrarDividas(filtro) {
      filtroAtual = filtro;
      // Atualizar bot√µes ativos
      document.querySelectorAll('#filtros .btn').forEach(btn => {
        btn.style.background = '';
        btn.style.color = '';
      });
      event.target.style.background = '#667eea';
      event.target.style.color = 'white';
      renderDividas();
    }

    function filtrarPorCategoria(categoria) {
      categoriaFiltro = categoria;
      renderDividas();
    }

    function abrirModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function fecharModal() {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        modal.style.display = 'none';
      });
      document.body.style.overflow = 'auto';
    }

    function showToast(message, type = 'info') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Inicializar quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', init);

    // Definir data atual como padr√£o
    window.onload = function() {
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('input-data').value = hoje;
      
      // Solicitar permiss√£o para notifica√ß√µes
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            console.log('Permiss√£o para notifica√ß√µes concedida');
          }
        });
      }
    };

    // Fechar modal ao clicar fora
    window.addEventListener('click', function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (event.target === modal) {
          fecharModal();
        }
      });
    });
  </script>
 </body>
</html>
